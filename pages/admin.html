<!DOCTYPE html>
<html>
  <head>
    <title>Admin | BLNT</title>
    <link rel="stylesheet" href="./css/adminPage.css">

  </head>
  <body>
    <p id="currentSceneText">
      Current Scene:
      <b id="currentSceneName">
        LOADING...
      </b>
    </p>

    <div id="nextSceneOptionsHolder">
    </div>

    <object type="image/svg+xml" data="./images/svg/flowchart.svg" id=svg_render></object>

    <div id="controlButtons">
      <button id="showChoiceColours" class="controlButton">Colour Next Scenes</button>
      <button id="resetAll" class="controlButton">Reset All</button>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();

      function buttonClicked(sceneName) {
        socket.emit("sceneSelect", sceneName)
      }

      window.onload = () => {
        document.getElementById("svg_render").contentDocument.documentElement.getElementById("overlayText").children[0].textContent = "Loading..."

        socket.emit("synchronize")

        socket.emit("getCurrentSceneName", (sceneName) => {
          document.getElementById("currentSceneName").textContent = sceneName;
        })
        document.getElementById("showChoiceColours").addEventListener("click", () => {
          socket.emit("colourChoices")
        })
        document.getElementById("resetAll").addEventListener("click", () => {
          if (confirm("Are you sure? This will reset everything!")) {
            socket.emit("reset")
          }
        })

        socket.on("currentSceneName", (sceneName) => {
          document.getElementById("currentSceneName").textContent = sceneName;
        })


        socket.on("sceneNameOptions", (sceneNames) => {
          var sceneChoiceButtons = document.getElementById("nextSceneOptionsHolder")

          while(sceneChoiceButtons.firstChild) {
            sceneChoiceButtons.removeChild(sceneChoiceButtons.lastChild)
          }

          for (const scene of sceneNames) {
            var item = document.createElement("button");
            item.className = "sceneChoiceButton"
            item.textContent = scene;

            item.addEventListener("click", (button) => {
              buttonClicked(button.target.textContent);
            })

            sceneChoiceButtons.appendChild(item);
          }
        })

        socket.on("colourUpdate", (objectID, colour) => {
          const selectedShape = document.getElementById("svg_render").contentDocument.documentElement.getElementById(objectID)

          if (selectedShape) {
            selectedShape.style["transition"] = "0.5s"
            selectedShape.style["fill"] = colour
          }
        })

        socket.on("overlayUpdate", (text) => {
          const textOverlay = document.getElementById("svg_render").contentDocument.documentElement.getElementById("overlayText");

          if(textOverlay) {
            if (!(textOverlay.children[0].textContent === text)) {
              changeText(textOverlay, text)
            }
          }
        })
      }

      //https://stackoverflow.com/questions/63980077/animate-text-content-with-js
      var changeText = function(textObject, newText) {
        item = textObject
        
        // item.animate(...) returns an Animation (refer to https://developer.mozilla.org/en-US/docs/Web/API/Element/animate)
        let animation = item.animate([
            // keyframes
            { opacity: '1' },
            { opacity: '0.9' },
            { opacity: '0.4' },
            { opacity: '0.1'},   
            { opacity: '0.0' }
            
          ], { 
            // timing options
            duration: 500,
            });
          
          /* The Animation has an eventHandler 
            refer to here: https://developer.mozilla.org/en-US/docs/Web/API/Animation
            and here: https://developer.mozilla.org/en-US/docs/Web/API/Animation/onfinish
          */
          animation.onfinish = function() {
            // change text 
            item.children[0].textContent = newText;

            //Apply text fudge factor
            textObject.children[0].x.baseVal[0].value = (document.getElementById("svg_render").contentDocument.documentElement.getElementById("overlayTextBacking").width["baseVal"].value 
            - (textObject.getBBox().width)) / 2
            //This works for some reason... Don't touch it

            // and start the second animation   
            item.animate([
            // keyframes
            { opacity: '0.0' },
            { opacity: '0.1' },
            { opacity: '0.4' },
            { opacity: '0.9'},   
            { opacity: '1' }
            
          ], { 
            // timing options
            duration: 500,
            
          });
        };
      }
    </script>
  </body>
</html>